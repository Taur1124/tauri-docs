---
import type { Props } from '@astrojs/starlight/props';
import Default from '@astrojs/starlight/components/Head.astro';

const imageURL = Object.fromEntries(
	Object.entries(import.meta.glob('../../content/docs/**/index.{md,mdx}')).map(([path]) => {
		path = path.replaceAll('../../content/docs', '');
		//path = path.replaceAll('../', '');
		path = path.replace('.mdx', '');
		path = path.replace('.md', '');
		const page = path.replace('index', '');
		return [page, path];
	})
);

const customImage: Record<string, string> = {
	'/blog': '/og.png',
	'/': '/og.png',
};

let socialImage: URL | null;

function getSocialImage() {
	let path = Astro.url.pathname;

	if (path.endsWith('.png')) {
		return null;
	}

	if (customImage[path]) {
		socialImage = new URL(customImage[path], Astro.url);
	} else {
		let imagePath = imageURL[path] || path.replace(/\/$/, '');
		// TODO: Improve cache busting
		socialImage = new URL(`/social-images/content/docs${imagePath}.png?v=1`, Astro.url);
	}
	return socialImage;
}
socialImage = getSocialImage();
---

<!-- /* TODO: - Check if is possible dynamic generate on astro.config head without overriding Head.astro - No specific reason
              - Make sure the URL pattern matches every page and if default fallback is working.
-->
<Default {...Astro.props} />
{
	socialImage && (
		<>
			<meta name="twitter:image" content={socialImage} />
			<meta property="og:image" content={socialImage} />
		</>
	)
}
